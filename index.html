<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- En Netlify puede inyectarse la URL del backend en esta meta tag -->
    <meta name="backend-url" content="">
    <title>Fotos de la Boda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Personalizaci√≥n para el spinner */
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid #E5E7EB; /* gray-200 */
            border-top-color: #EC4899; /* pink-500 */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-100 via-purple-50 to-blue-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-2xl">
        
        <header class="text-center mb-6">
            <div class="w-16 h-16 mx-auto mb-3 bg-pink-400 rounded-full flex items-center justify-center text-4xl shadow-xl">
                üì∏
            </div>        

        <section class="mb-8 rounded-2xl overflow-hidden shadow-2xl relative h-92">
            <img src="/hero.png" alt="Foto de Boda" class="w-full h-full object-cover filter brightness-75">
            <div class="absolute inset-0 flex flex-col items-center justify-center text-white p-4 bg-black bg-opacity-30">
                <h1 class="text-4xl font-bold text-gray-100 mb-1">Lili & Rene | 2025</h1>
            <p class="text-gray-200">Comparte tus mejores momentos con nosotros üíï</p>
                <p class="mt-2 text-xl font-light">Tu foto es el mejor regalo üéÅ</p>
            </div>
        </section>
</header>
        <div id="configNotice" class="bg-yellow-50 border-2 border-yellow-400 rounded-xl p-5 mb-6">
            <h3 class="font-bold text-yellow-800 mb-2">‚öôÔ∏è Configuraci√≥n Requerida</h3>
            <ol class="list-decimal list-inside text-yellow-700 text-sm space-y-1">
                <li>Obt√©n Client ID y API Key de Google Cloud Console</li>
                <li>Reempl√°zalos en el c√≥digo (busca CONFIG al inicio del script)</li>
                <li>Recarga la p√°gina</li>
            </ol>
        </div>

        <div id="authSection" class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <p class="text-gray-700 mb-6">Conecta con Google Drive para subir tus fotos</p>
            <button id="loginBtn" 
                    class="inline-flex items-center gap-3 px-8 py-3 bg-white border-2 border-gray-300 rounded-lg font-semibold hover:border-blue-500 hover:bg-gray-50 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Conectar con Google Drive
            </button>
        </div>

        <div id="uploadSection" class="bg-white rounded-2xl shadow-xl p-8 hidden">
            <div class="mb-6">
                <label for="guestName" class="flex items-center text-gray-700 font-semibold mb-2">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Tu Nombre
                </label>
                <input type="text" 
                        id="guestName" 
                        placeholder="Ej: Mar√≠a Garc√≠a"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:outline-none">
            </div>

            <div class="mb-6">
                <label class="flex items-center text-gray-700 font-semibold mb-2">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Selecciona Fotos o Videos
                </label>
                <label for="fileInput" class="block border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-pink-400 hover:bg-gray-50 transition-all">
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <p class="text-gray-600 mb-2">Haz clic para seleccionar m√°s archivos</p>
                    <p class="text-sm text-gray-400">Acepta fotos y videos</p>
                </label>
                <input type="file" id="fileInput" multiple accept="image/*,video/*" class="hidden">
            </div>

            <div id="previewSection" class="mb-6 hidden">
                <p class="text-sm font-semibold text-gray-700 mb-3">Archivos seleccionados: (<span id="fileCount">0</span>)</p>
                <div id="previewGrid" class="grid grid-cols-3 gap-3"></div>
            </div>

            <button id="uploadBtn" 
                    disabled
                    class="w-full py-4 rounded-lg font-bold text-white bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all shadow-lg">
                Subir Archivos
            </button>

            <div id="loadingSection" class="hidden text-center py-6">
                <div class="loader mx-auto mb-3"></div>
                <p class="text-gray-600">Subiendo archivos...</p>
            </div>

            <div id="statusMessage"></div>
        </div>

        <footer class="text-center mt-8 text-gray-600 text-sm">
            <p>Gracias por compartir este momento especial con nosotros ‚ù§Ô∏è</p>
        </footer>
    </div>

    <script>

        // Determinar la base del API (puede inyectarse en Netlify como meta tag 'backend-url')
        const META_BACKEND = document.querySelector('meta[name="backend-url"]');
        const API_BASE = (META_BACKEND && META_BACKEND.content && META_BACKEND.content.trim())
            ? META_BACKEND.content.trim().replace(/\/$/, '')
            : '';

        async function uploadToBackend(file, guestName) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("guestName", guestName);
            const url = API_BASE ? `${API_BASE}/upload` : `/upload`;
            const res = await fetch(url, {
                method: "POST",
                body: formData
            });
            // lanzar si status no OK para que el caller entre en catch
            if (!res.ok) {
                const txt = await res.text().catch(() => res.statusText || 'error');
                throw new Error(txt || `HTTP ${res.status}`);
            }
            return await res.json();
        }


        // =====================================================
        // UI HELPERS
        // =====================================================
        const UI = {
            showStatus(message, type = 'info') {
                const statusDiv = document.getElementById('statusMessage');
                const icons = { success: '‚úì', error: '‚úï', info: '‚Ñπ' };
                const colors = {
                    success: 'bg-green-50 text-green-800 border-green-200',
                    error: 'bg-red-50 text-red-800 border-red-200',
                    info: 'bg-blue-50 text-blue-800 border-blue-200'
                };

                const colorClass = colors[type] || colors.info;
                const icon = icons[type] || icons.info;

                statusDiv.innerHTML = `
                    <div class="mt-4 p-4 rounded-lg border-2 flex items-center gap-3 ${colorClass}">
                        <span class="text-xl flex-shrink-0">${icon}</span>
                        <span>${message}</span>
                    </div>
                `;

                if (type === 'success') {
                    setTimeout(() => statusDiv.innerHTML = '', 5000);
                }
            },

            showLoading(show) {
                document.getElementById('loadingSection').classList.toggle('hidden', !show);
            },

            showUploadSection(show) {
                document.getElementById('authSection').classList.toggle('hidden', show);
                document.getElementById('uploadSection').classList.toggle('hidden', !show);
                document.getElementById('configNotice').classList.toggle('hidden', show);
            }
        };


        // =====================================================
        // STATE + ELEMENTS
        // =====================================================
        const state = {
            selectedFiles: [], // { file, url }
        };

        const els = {
            fileInput: document.getElementById('fileInput'),
            guestName: document.getElementById('guestName'),
            uploadBtn: document.getElementById('uploadBtn'),
            previewSection: document.getElementById('previewSection'),
            previewGrid: document.getElementById('previewGrid'),
            fileCount: document.getElementById('fileCount'),
            loginBtn: document.getElementById('loginBtn')
        };


        // =====================================================
        // EVENTS
        // =====================================================
        els.loginBtn.addEventListener('click', () => {
            // Simulamos login y mostramos la secci√≥n de subida
            UI.showUploadSection(true);
            UI.showStatus('Conexi√≥n simulada con Google Drive. Ya puedes subir archivos.', 'success');
        });

        els.fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files || []);
            // A√±adir archivos nuevos y crear object URLs
            files.forEach(file => {
                const url = URL.createObjectURL(file);
                state.selectedFiles.push({ file, url });
            });
            updatePreview();
            updateButton();
        });

        els.guestName.addEventListener('input', updateButton);

        els.uploadBtn.addEventListener('click', async () => {
            if (!els.guestName.value.trim() || state.selectedFiles.length === 0) return;

            // Disable controls while uploading
            els.uploadBtn.disabled = true;
            els.fileInput.disabled = true;
            els.guestName.disabled = true;
            UI.showLoading(true);

            let allSuccess = true;
            for (const item of state.selectedFiles) {
                try {
                    UI.showStatus(`Subiendo ${item.file.name}...`, 'info');
                    const res = await uploadToBackend(item.file, els.guestName.value.trim());
                    // Se asume que la API responde { ok: true } u objeto similar
                    if (res && (res.ok === false || res.error)) {
                        allSuccess = false;
                        UI.showStatus(`Error subiendo ${item.file.name}: ${res.error || 'respuesta no OK'}`, 'error');
                    } else {
                        UI.showStatus(`Archivo ${item.file.name} subido correctamente.`, 'success');
                    }
                } catch (err) {
                    allSuccess = false;
                    UI.showStatus(`Error subiendo ${item.file.name}: ${err.message || err}`, 'error');
                }
            }

            UI.showLoading(false);
            if (allSuccess) {
                UI.showStatus('Todos los archivos se subieron correctamente.', 'success');
                resetForm();
            } else {
                // mantener selecci√≥n para reintento
                els.uploadBtn.disabled = false;
                els.fileInput.disabled = false;
                els.guestName.disabled = false;
            }
        });


        // =====================================================
        // HELPERS: preview, remove, reset
        // =====================================================
        function updatePreview() {
            const count = state.selectedFiles.length;
            els.fileCount.textContent = String(count);

            if (count === 0) {
                els.previewSection.classList.add('hidden');
                els.previewGrid.innerHTML = '';
                return;
            }

            els.previewSection.classList.remove('hidden');
            els.previewGrid.innerHTML = '';

            state.selectedFiles.forEach((item, idx) => {
                const container = document.createElement('div');
                container.className = 'relative aspect-square rounded-lg overflow-hidden border-2 border-gray-200 bg-white flex items-center justify-center';

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'absolute top-1 right-1 bg-white/80 rounded-full p-1 text-sm';
                removeBtn.title = 'Eliminar archivo';
                removeBtn.innerText = '‚úï';
                removeBtn.addEventListener('click', () => removeFile(idx));
                container.appendChild(removeBtn);

                if (item.file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = item.url;
                    img.className = 'w-full h-full object-cover';
                    img.alt = item.file.name;
                    container.appendChild(img);
                } else if (item.file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = item.url;
                    video.className = 'w-full h-full object-cover';
                    video.controls = true;
                    video.muted = true;
                    video.playsInline = true;
                    container.appendChild(video);
                } else {
                    const span = document.createElement('div');
                    span.className = 'text-4xl';
                    span.innerText = 'üìÑ';
                    container.appendChild(span);
                }

                els.previewGrid.appendChild(container);
            });
        }

        function removeFile(index) {
            const item = state.selectedFiles[index];
            if (item && item.url) URL.revokeObjectURL(item.url);
            state.selectedFiles.splice(index, 1);
            updatePreview();
            updateButton();
        }

        function resetForm() {
            // revoke URLs
            state.selectedFiles.forEach(it => it.url && URL.revokeObjectURL(it.url));
            state.selectedFiles = [];
            els.fileInput.value = '';
            els.guestName.value = '';
            els.fileInput.disabled = false;
            els.guestName.disabled = false;
            els.uploadBtn.disabled = true;
            updatePreview();
        }

        function updateButton() {
            els.uploadBtn.disabled = !els.guestName.value.trim() || state.selectedFiles.length === 0;
        }

    </script>

</body>
</html>








