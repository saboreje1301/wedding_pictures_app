<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fotos de la Boda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Personalizaci√≥n para el spinner */
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid #E5E7EB; /* gray-200 */
            border-top-color: #EC4899; /* pink-500 */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-100 via-purple-50 to-blue-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-2xl">
        
        <header class="text-center mb-6">
            <div class="w-16 h-16 mx-auto mb-3 bg-pink-400 rounded-full flex items-center justify-center text-4xl shadow-xl">
                üì∏
            </div>        

        <section class="mb-8 rounded-2xl overflow-hidden shadow-2xl relative h-92">
            <img src="/hero.png" alt="Foto de Boda" class="w-full h-full object-cover filter brightness-75">
            <div class="absolute inset-0 flex flex-col items-center justify-center text-white p-4 bg-black bg-opacity-30">
                <h1 class="text-4xl font-bold text-gray-100 mb-1">Lili & Rene | 2025</h1>
            <p class="text-gray-200">Comparte tus mejores momentos con nosotros üíï</p>
                <p class="mt-2 text-xl font-light">Tu foto es el mejor regalo üéÅ</p>
            </div>
        </section>
</header>
        <div id="configNotice" class="bg-yellow-50 border-2 border-yellow-400 rounded-xl p-5 mb-6">
            <h3 class="font-bold text-yellow-800 mb-2">‚öôÔ∏è Configuraci√≥n Requerida</h3>
            <ol class="list-decimal list-inside text-yellow-700 text-sm space-y-1">
                <li>Obt√©n Client ID y API Key de Google Cloud Console</li>
                <li>Reempl√°zalos en el c√≥digo (busca CONFIG al inicio del script)</li>
                <li>Recarga la p√°gina</li>
            </ol>
        </div>

        <div id="authSection" class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <p class="text-gray-700 mb-6">Conecta con Google Drive para subir tus fotos</p>
            <button id="loginBtn" 
                    class="inline-flex items-center gap-3 px-8 py-3 bg-white border-2 border-gray-300 rounded-lg font-semibold hover:border-blue-500 hover:bg-gray-50 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Conectar con Google Drive
            </button>
        </div>

        <div id="uploadSection" class="bg-white rounded-2xl shadow-xl p-8 hidden">
            <div class="mb-6">
                <label class="flex items-center text-gray-700 font-semibold mb-2">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Tu Nombre
                </label>
                <input type="text" 
                        id="guestName" 
                        placeholder="Ej: Mar√≠a Garc√≠a"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:outline-none">
            </div>

            <div class="mb-6">
                <label class="flex items-center text-gray-700 font-semibold mb-2">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Selecciona Fotos o Videos
                </label>
                <label for="fileInput" class="block border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-pink-400 hover:bg-gray-50 transition-all">
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <p class="text-gray-600 mb-2">Haz clic para seleccionar m√°s archivos</p>
                    <p class="text-sm text-gray-400">Acepta fotos y videos</p>
                </label>
                <input type="file" id="fileInput" multiple accept="image/*,video/*" class="hidden">
            </div>

            <div id="previewSection" class="mb-6 hidden">
                <p class="text-sm font-semibold text-gray-700 mb-3">Archivos seleccionados: (<span id="fileCount">0</span>)</p>
                <div id="previewGrid" class="grid grid-cols-3 gap-3"></div>
            </div>

            <button id="uploadBtn" 
                    disabled
                    class="w-full py-4 rounded-lg font-bold text-white bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all shadow-lg">
                Subir Archivos
            </button>

            <div id="loadingSection" class="hidden text-center py-6">
                <div class="loader mx-auto mb-3"></div>
                <p class="text-gray-600">Subiendo archivos...</p>
            </div>

            <div id="statusMessage"></div>
        </div>

        <footer class="text-center mt-8 text-gray-600 text-sm">
            <p>Gracias por compartir este momento especial con nosotros ‚ù§Ô∏è</p>
        </footer>
    </div>

    <script>
        // =====================================================
        // CONFIGURACI√ìN - ‚ö†Ô∏è REEMPLAZA ESTOS VALORES
        // =====================================================
    const CONFIG = {
        CLIENT_ID: '147697427621-7bpr9e0q1p5jia9dnkbp1lpar24h0brc.apps.googleusercontent.com', // ‚Üê Pega tu Client ID aqu√≠
        API_KEY: 'AIzaSyAapZyk3wXUzF9mFbqOzzbm17jSLiwl5WM',          // ‚Üê Pega tu API Key aqu√≠
        FOLDER_NAME: 'Fotos_Boda',
        SCOPES: 'https://www.googleapis.com/auth/drive.file',
        DISCOVERY_DOCS: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        };


        // =====================================================
        // ESTADO GLOBAL
        // =====================================================
        const state = {
            gapiInited: false,
            gisInited: false,
            tokenClient: null,
            accessToken: null,
            selectedFiles: []
        };

        // =====================================================
        // UI HELPERS
        // =====================================================
        const UI = {
            showStatus(message, type = 'info') {
                const statusDiv = document.getElementById('statusMessage');
                const icons = { success: '‚úì', error: '‚úï', info: '‚Ñπ' };
                const colors = {
                    success: 'bg-green-50 text-green-800 border-green-200',
                    error: 'bg-red-50 text-red-800 border-red-200',
                    info: 'bg-blue-50 text-blue-800 border-blue-200'
                };
                
                statusDiv.innerHTML = `
                    <div class="mt-4 p-4 rounded-lg border-2 flex items-center gap-3 ${colors[type]}">
                        <span class="text-xl flex-shrink-0">${icons[type]}</span>
                        <span>${message}</span>
                    </div>
                `;
                
                if (type === 'success') {
                    setTimeout(() => statusDiv.innerHTML = '', 5000);
                }
            },

            showLoading(show) {
                document.getElementById('loadingSection').classList.toggle('hidden', !show);
            },

            showUploadSection(show) {
                document.getElementById('authSection').classList.toggle('hidden', show);
                document.getElementById('uploadSection').classList.toggle('hidden', !show);
                document.getElementById('configNotice').classList.toggle('hidden', show);
            }
        };

        // =====================================================
        // GOOGLE API
        // =====================================================
        const GoogleAPI = {
            async init() {
                await new Promise((resolve) => gapi.load('client', resolve));
                await gapi.client.init({
                    apiKey: CONFIG.API_KEY,
                    discoveryDocs: CONFIG.DISCOVERY_DOCS,
                });
                state.gapiInited = true;
                console.log('GAPI initialized');
                this.checkReady();
            },

            checkReady() {
                if (state.gapiInited && state.gisInited) {
                    console.log('Google APIs ready');
                    Auth.init();
                }
            },

            async findOrCreateFolder(folderName, parentId = null) {
                const query = parentId 
                    ? `name='${folderName}' and '${parentId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`
                    : `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
                
                const response = await gapi.client.drive.files.list({
                    q: query,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                
                if (response.result.files.length > 0) {
                    return response.result.files[0].id;
                }
                
                const metadata = {
                    name: folderName,
                    mimeType: 'application/vnd.google-apps.folder'
                };
                
                if (parentId) {
                    metadata.parents = [parentId];
                }
                
                const createResponse = await gapi.client.drive.files.create({
                    resource: metadata,
                    fields: 'id'
                });
                
                return createResponse.result.id;
            },

            async uploadFile(file, folderId) {
                const metadata = {
                    name: `${Date.now()}_${file.name}`,
                    parents: [folderId]
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);
                
                const response = await fetch(
                    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name',
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${state.accessToken}` },
                        body: form
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }
                
                return await response.json();
            }
        };

        // =====================================================
        // AUTH
        // =====================================================
        const Auth = {
            init() {
                if (CONFIG.CLIENT_ID.includes('XXXXXXXXXX')) {
                    console.error('Client ID no configurado');
                    return;
                }
                
                state.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.CLIENT_ID,
                    scope: CONFIG.SCOPES,
                    callback: (response) => {
                        if (response.error) {
                            UI.showStatus('Error de autenticaci√≥n: ' + response.error, 'error');
                            return;
                        }
                        
                        if (response.access_token) {
                            state.accessToken = response.access_token;
                            UI.showUploadSection(true);
                            UI.showStatus('Conectado exitosamente a Google Drive', 'success');
                        }
                    },
                });

                document.getElementById('loginBtn').addEventListener('click', this.login.bind(this));
            },

            login() {
                if (!state.tokenClient) {
                    UI.showStatus('Por favor configura tu Client ID y API Key primero', 'error');
                    return;
                }
                state.tokenClient.requestAccessToken({ prompt: 'consent' });
            }
        };

        // =====================================================
        // UPLOADER
        // =====================================================
        const Uploader = {
            init() {
                const fileInput = document.getElementById('fileInput');
                const nameInput = document.getElementById('guestName');
                const uploadBtn = document.getElementById('uploadBtn');
                
                // --- CAMBIO CLAVE PARA ACUMULAR ARCHIVOS ---
                fileInput.addEventListener('change', (e) => {
                    // CONCATENA los nuevos archivos a la lista existente
                    state.selectedFiles = state.selectedFiles.concat(Array.from(e.target.files));
                    // Limpia el input para que el evento 'change' se active de nuevo si se selecciona el mismo archivo
                    e.target.value = ''; 
                    this.updatePreview();
                    this.updateButton();
                });
                
                nameInput.addEventListener('input', () => this.updateButton());
                uploadBtn.addEventListener('click', () => this.upload());
            },

            removeFile(index) {
                // Funci√≥n para eliminar un archivo de la lista por su √≠ndice
                state.selectedFiles.splice(index, 1);
                this.updatePreview();
                this.updateButton();
                UI.showStatus(`Archivo eliminado de la lista.`, 'info');
            },

            updatePreview() {
                const previewSection = document.getElementById('previewSection');
                const previewGrid = document.getElementById('previewGrid');
                const fileCountSpan = document.getElementById('fileCount');
                
                fileCountSpan.textContent = state.selectedFiles.length;

                if (state.selectedFiles.length === 0) {
                    previewSection.classList.add('hidden');
                    return;
                }
                
                previewSection.classList.remove('hidden');
                previewGrid.innerHTML = '';
                
                state.selectedFiles.forEach((file, index) => {
                    const div = document.createElement('div');
                    // A√±adimos 'group' para poder mostrar el bot√≥n de eliminar solo al pasar el rat√≥n
                    div.className = 'relative aspect-square rounded-lg overflow-hidden border-2 border-gray-200 group';
                    
                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(file);
                        img.className = 'w-full h-full object-cover';
                        div.appendChild(img);
                    } else {
                        div.className += ' bg-gray-100 flex items-center justify-center';
                        div.innerHTML = '<span class="text-3xl">üé•</span>';
                    }
                    
                    // NUEVO: Bot√≥n de Eliminar Archivo
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'absolute top-1 right-1 w-6 h-6 bg-red-600 text-white rounded-full flex items-center justify-center text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity z-10';
                    removeBtn.innerHTML = '‚úï';
                    // Usamos una funci√≥n an√≥nima para pasar el √≠ndice
                    removeBtn.onclick = (e) => {
                        e.preventDefault(); // Previene la propagaci√≥n de eventos
                        Uploader.removeFile(index);
                    };
                    div.appendChild(removeBtn);

                    previewGrid.appendChild(div);
                });
            },

            updateButton() {
                const btn = document.getElementById('uploadBtn');
                const name = document.getElementById('guestName').value.trim();
                btn.disabled = !name || state.selectedFiles.length === 0;
            },

            async upload() {
                const guestName = document.getElementById('guestName').value.trim();
                
                if (!guestName || state.selectedFiles.length === 0) {
                    UI.showStatus('Por favor completa todos los campos', 'error');
                    return;
                }
                
                if (!state.accessToken) {
                    UI.showStatus('No est√°s autenticado', 'error');
                    return;
                }
                
                document.getElementById('uploadBtn').disabled = true;
                UI.showLoading(true);
                
                try {
                    const mainFolderId = await GoogleAPI.findOrCreateFolder(CONFIG.FOLDER_NAME);
                    // Sanitiza el nombre para crear la subcarpeta (Ej: Maria_Garcia)
                    const sanitizedGuestName = guestName.replace(/[^a-z0-9]/gi, '_'); 
                    const guestFolderId = await GoogleAPI.findOrCreateFolder(sanitizedGuestName, mainFolderId);
                    
                    let successCount = 0;
                    for (const file of state.selectedFiles) {
                        try {
                            await GoogleAPI.uploadFile(file, guestFolderId);
                            successCount++;
                        } catch (error) {
                            console.error('Error uploading file:', file.name, error);
                        }
                    }
                    
                    if (successCount === state.selectedFiles.length) {
                        UI.showStatus(`¬°${successCount} archivo(s) subido(s) exitosamente! üéâ`, 'success');
                    } else {
                        UI.showStatus(`Archivos subidos con errores. ${successCount} de ${state.selectedFiles.length} subidos correctamente.`, 'info');
                    }
                    
                    this.reset();
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    UI.showStatus('Error al subir archivos. Por favor intenta de nuevo.', 'error');
                } finally {
                    UI.showLoading(false);
                    document.getElementById('uploadBtn').disabled = false;
                }
            },

            reset() {
                document.getElementById('guestName').value = '';
                document.getElementById('fileInput').value = '';
                // Tambi√©n necesitamos liberar la memoria de las URLs creadas
                state.selectedFiles.forEach(file => URL.revokeObjectURL(file)); 
                state.selectedFiles = [];
                this.updatePreview();
                this.updateButton();
            }
        };

        // =====================================================
        // INICIALIZACI√ìN
        // =====================================================
        window.gapiLoaded = function() {
            GoogleAPI.init();
        };

        window.gisLoaded = function() {
            state.gisInited = true;
            console.log('GIS initialized');
            GoogleAPI.checkReady();
        };

        // Iniciar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => Uploader.init());
        } else {
            Uploader.init();
        }
    </script>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>








